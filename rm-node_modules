#!/usr/bin/env bash

# program info
version="0.1.1"
homepage="https://github.com/simbo/rm-node_modules"
license="MIT Â© 2021 Simon Lepel <simbo@simbo.de>"

# formatting vars
red=$(tput setaf 9)
green=$(tput setaf 10)
yellow=$(tput setaf 11)
blue=$(tput setaf 12)
gray=$(tput setaf 8)
white=$(tput setaf 15)
bold=$(tput bold)
underlined=$(tput smul)
normal=$(tput sgr0)

# help message
function usage() {
  printf "\nUsage:  $(basename "$0") [-yu] [-d <DIR>]\n\n"
  printf "\"Search for node_modules directories within given path and delete them.\"\n\n"
  printf "Options:\n"
  printf "  -d <DIR>  directory to search within (default: current directory)\n"
  printf "  -y        delete without confirmation\n"
  printf "  -u        determine disk usage\n"
  exit 0
}

# default options
yes=false
ddu=false
dir="."

# print welcome message
printf "${white}${bold}rm-node_modules${normal} $version\n${gray}${underlined}$homepage${normal}\n${gray}$license${normal}\n"

# set options
while getopts yud: opt 2>/dev/null
do
  case $opt in
    y) yes=true;;
    u) ddu=true;;
    d) dir=$OPTARG;;
    ?) usage;;
  esac
done

# change to base dir
cd "$dir"
baseDir="$(pwd)"

# directory name to search for
searchDir="node_modules"

# searching directories
printf "\nSearching for ${yellow}$searchDir${normal} directories within ${blue}$baseDir${normal}...\n"
items="$(find . -name "$searchDir" -type d -prune)"

# count found items
if [[ $items = "" ]]; then
  itemsCount="0"
else
  itemsCount="$(echo "$items" | wc -l | xargs)"
fi

# print search results
printf "Found ${white}${bold}$itemsCount directories${normal}.\n"

# exit if zero
if [[ $itemsCount = 0 ]]; then
  printf "\n${gray}Nothing to do. Quitting...${normal}\n"
  exit 0
fi

# if determining disk usage
if [[ $ddu = true ]]; then
  # display info about determining disk usage
  printf "\nDetermining disk usage of $itemsCount ${yellow}$searchDir${normal} directories...\n"
  # get disk usage of directories
  diskUsage="$(echo "$items" | sed 's/./\\&/g' | xargs du -chs)"
  # get total value of disk usage
  diskUsageTotal="$(echo "$diskUsage" | tail -n1 | cut -d$'\t' -f 1)"
  # display disk usage
  printf "\n$diskUsage\n"
# if determining disk usage skipped
else
  # display found directories
  printf "\n$items\n"
fi

# if confirmation not skipped
if [[ $yes = false ]]; then
  # ask for action
  printf "\nPress ${red}${bold}[ENTER]${normal}${red} to delete${normal} the directories or any other key to exit.\n"
  printf "${gray}(${bold}"
  # if determined disk usage
  if [[ $ddu = true ]]; then
    # display space to be freed
    printf "$diskUsageTotal of data"
  # if determining disk usage skipped
  else
    # display number of found directories
    printf "$itemsCount directories"
  fi
  # display deletion info
  printf "${normal}${gray} will be irreversibly deleted.)${normal}\n"
  # read input
  IFS= read -s -n 1 key
  # if enter key pressed
  if [[ $key = "" ]]; then
    yes=true
  fi
fi

# if deletion confirmed
if [[ $yes = true ]]; then
  # display info about deletion
  printf "\nDeleting ${yellow}$searchDir${normal} directories within ${blue}$baseDir${normal}...\n"
  # delete all found directories
  echo "$items" | sed 's/./\\&/g' | xargs rm -rf --
  # display deletion result
  printf "\nDeleted ${white}${bold}$itemsCount directories${normal}"
  # if determined disk usage
  if [[ $ddu = true ]]; then
    # display freed disk space
    printf " and freed ${green}${bold}$diskUsageTotal of disk space${normal}"
  fi
  printf ".\n"
# if deletion not confirmed
else
  # exit
  printf "\n${gray}Canceled.${normal}\n"
fi
